pipeline {
  agent any
  environment {
    DOTNET_CLI_TELEMETRY_OPTOUT = '1'
    CSPROJ      = 'summerProject/ApiGateway/YarpApiGateway/YarpApiGateway.csproj'
    PROJECT_DIR = 'summerProject/ApiGateway/YarpApiGateway'

    DOCKERHUB   = credentials('dockerhub-creds')
    IMAGE_REPO  = 'duythong2/yarpgateway'
    IMAGE_TAG   = "${env.BUILD_NUMBER}"

    SONAR_TOKEN       = credentials('sonartoken')
    SONAR_PROJECT_KEY = 'yarpGateway'
  }
  options { timestamps() }

  stages {
    stage('Checkout') { steps { checkout scm } }

    stage('Start Analysis') {
      steps {
        withSonarQubeEnv('sonarServer') {
          sh '''
            set -e
            # Use local .NET tool manifest instead of global tool (avoid race)
            if [ ! -f .config/dotnet-tools.json ]; then
              dotnet new tool-manifest
              dotnet tool install dotnet-sonarscanner --version 10.3.0
            else
              dotnet tool restore
            fi

            dotnet tool run dotnet-sonarscanner begin \
              /k:"$SONAR_PROJECT_KEY" \
              /d:sonar.login="$SONAR_TOKEN" \
              /d:sonar.host.url="$SONAR_HOST_URL"
          '''
        }
      }
    }

    stage('Restore & Test') {
      steps {
        sh '''
          dotnet restore "$CSPROJ"
          dotnet test "$CSPROJ" -c Release --logger "trx;LogFileName=test.trx"
        '''
      }
    }

    stage('Build & Publish') {
      steps {
        sh 'dotnet publish "$CSPROJ" -c Release -o "$PROJECT_DIR/publish"'
      }
    }

    stage('Finish Analysis') {
      steps {
        withSonarQubeEnv('sonarServer') {
          sh '''
            dotnet tool run dotnet-sonarscanner end /d:sonar.login="$SONAR_TOKEN"
          '''
        }
      }
    }

    stage('Quality Gate') {
      steps {
        timeout(time: 10, unit: 'MINUTES') {
          script {
            def qg = waitForQualityGate()
            if (qg.status != 'OK') { error "Quality Gate failed: ${qg.status}" }
          }
        }
      }
    }

    stage('Docker Build & Push') {
      when {
        changeset comparator: 'ANT', pattern: '''
          summerProject/ApiGateway/**/*
          summerProject/Shared/**/*
        '''
      }
      steps {
        sh '''
          echo "$DOCKERHUB_PSW" | docker login -u "$DOCKERHUB_USR" --password-stdin
          docker build -t "$IMAGE_REPO":"$IMAGE_TAG" -f "$PROJECT_DIR/Dockerfile" summerProject
          docker push  "$IMAGE_REPO":"$IMAGE_TAG"
          docker tag   "$IMAGE_REPO":"$IMAGE_TAG" "$IMAGE_REPO":latest
          docker push  "$IMAGE_REPO":latest
        '''
      }
    }
  }

  post {
    always { junit allowEmptyResults: true, testResults: '**/TestResults/**/*.trx' }
  }
}
